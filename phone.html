<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Phone Dashboard</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
  <div class="page-loader" data-page-loader>
    <div class="spinner" aria-label="Loading" role="status"></div>
  </div>
<header class="topbar">
      <div class="brand">
        <span class="brand-name">Asset Tracking</span>
      </div>
          <nav class="topbar-nav">
        <a href="index.html" data-nav="store" data-permission="store">Store</a>
        <a href="phone.html" data-nav="phones" data-permission="store_phone">Phones</a>
        <a href="phone-dashboard.html" data-nav="dashboard" data-permission="store_phone">Dashboard</a>
        <a href="user-management.html" data-permission="admin_user_management" data-nav="user-management">
          User management
        </a>
        <a href="audit-log.html" data-permission="admin_audit_log" data-nav="audit-log">Audit log</a>
      </nav>
      <div class="topbar-actions">
        <button class="icon-button" type="button" aria-label="Search">
          ⌕
        </button>
        <div class="user-menu">
          <button class="user-chip user-chip-button" type="button" data-user-menu-toggle>
            <span class="user-label">User</span>
            <span class="user-name" data-current-user>Guest</span>
            <span class="user-caret">▾</span>
          </button>
          <div class="user-dropdown" data-user-menu>
            <a class="dropdown-link" href="logout.html" data-logout-link>Logout</a>
          </div>
        </div>
      </div>
    </header>

    <main class="dashboard">
      <section class="hero-store">
        <div>
          <p class="hero-kicker">Phone flow</p>
          <h1>Phone operations dashboard</h1>
          <p class="subtitle">
            Manage receiving and issuing for phones with a focused master list.
          </p>
        </div>
      </section>

      <section class="detail-grid">
        <a class="detail-card-link" href="phone-dashboard.html">
          <article class="detail-card card-dashboard">
            <div class="card-hero hero-dashboard"></div>
            <h2>Dashboard</h2>
            <p>See a live summary of registered devices by model and location.</p>
          </article>
        </a>

        <a
          class="detail-card-link"
          href="phone-master-list.html"
          data-permission="phone_register_device"
        >
          <article class="detail-card card-register">
            <div class="card-hero hero-register"></div>
            <h2>Register a device</h2>
            <p>Add phones to the master list and manage their status.</p>
          </article>
        </a>

        <a
          class="detail-card-link"
          href="location-list.html"
          data-permission="phone_location_list"
        >
          <article class="detail-card card-location" id="locationListCard">
            <div class="card-hero hero-location"></div>
            <div class="card-title-row">
              <h2>Location list</h2>
              <span class="card-badge" id="locationPendingBadge" hidden>0</span>
            </div>
            <p>View pending devices per location and confirm scanned handoffs.</p>
          </article>
        </a>

        <a
          class="detail-card-link"
          href="phone-issuing.html"
          data-permission="phone_issuing"
        >
          <article class="detail-card card-issuing">
            <div class="card-hero hero-issuing"></div>
            <h2>Issuing</h2>
            <p>Allocate phones to teams, capture handoff, and update status.</p>
          </article>
        </a>
      </section>
    </main>
    <script src="config.js"></script>
    <script src="api.js"></script>
    <script src="app-permissions.js"></script>
    <script src="app-session.js"></script>
    <script>
      const pendingBadge = document.getElementById("locationPendingBadge");
      const locationCard = document.getElementById("locationListCard");

      const parseLocations = (value) =>
        String(value || "")
          .split(",")
          .map((item) => item.trim())
          .filter(Boolean);

      const updatePendingBadge = async () => {
        if (!window.assetTrackingApi?.getToken()) {
          return;
        }
        try {
          const [me, deviceData, holdingsData] = await Promise.all([
            window.assetTrackingApi.apiFetch("/api/me"),
            window.assetTrackingApi.apiFetch("/api/devices"),
            window.assetTrackingApi.apiFetch("/api/ops-holdings"),
          ]);
          const locations = parseLocations(me?.user?.location || "");
          if (!locations.length) {
            return;
          }
          const locationSet = new Set(locations);
          const holdings = holdingsData.holdings || [];
          const devices = deviceData.devices || [];
          const holdingIds = new Set(
            holdings.map((hold) => String(hold.device_identifier || ""))
          );
          const pendingCount = devices.filter(
            (device) =>
              locationSet.has(device.device_location) &&
              !holdingIds.has(String(device.device_id || ""))
          ).length;
          if (pendingCount > 0) {
            pendingBadge.textContent = pendingCount > 99 ? "99+" : pendingCount;
            pendingBadge.hidden = false;
            pendingBadge.style.display = "inline-flex";
            locationCard?.classList.add("has-pending");
          } else {
            pendingBadge.textContent = "";
            pendingBadge.hidden = true;
            pendingBadge.style.display = "none";
            locationCard?.classList.remove("has-pending");
          }
        } catch (error) {
          pendingBadge.textContent = "";
          pendingBadge.hidden = true;
          pendingBadge.style.display = "none";
          locationCard?.classList.remove("has-pending");
        }
      };

      updatePendingBadge();
    </script>
      <script src="loader.js"></script>
  </body>
</html>
