<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Audit Log</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
  <div class="page-loader" data-page-loader>
    <div class="spinner" aria-label="Loading" role="status"></div>
  </div>
<header class="topbar">
      <div class="brand">
        <span class="brand-name">Asset Tracking</span>
      </div>
          <nav class="topbar-nav">
        <a href="index.html" data-nav="store" data-permission="store">Store</a>
        <a href="phone.html" data-nav="phones" data-permission="store_phone">Phones</a>        <a href="user-management.html" data-permission="admin_user_management" data-nav="user-management">
          User management
        </a>
        <a href="audit-log.html" data-permission="admin_audit_log" data-nav="audit-log">Audit log</a>
      </nav>
      <div class="topbar-actions">
        <button class="icon-button" type="button" aria-label="Search">
          ⌕
        </button>
        <div class="user-menu">
          <button class="user-chip user-chip-button" type="button" data-user-menu-toggle>
            <span class="user-label">User</span>
            <span class="user-name" data-current-user>Guest</span>
            <span class="user-caret">▾</span>
          </button>
          <div class="user-dropdown" data-user-menu>
            <a class="dropdown-link" href="logout.html" data-logout-link>Logout</a>
          </div>
        </div>
      </div>
    </header>

    <main class="dashboard" data-permission="admin_audit_log">
      <section class="hero-store">
        <div>
          <p class="hero-kicker">Administration</p>
          <h1>Audit log</h1>
          <p class="subtitle">Local activity history (latest first).</p>
        </div>
      </section>

      <section class="form-card">
        <div class="list-header">
          <div>
            <h2>Events</h2>
            <p class="subtitle">Tracked actions across the system.</p>
          </div>
          <div class="list-actions">
            <button class="secondary-button" type="button" id="clearAuditButton">
              Clear logs
            </button>
          </div>
        </div>
        <div class="table-wrap">
          <table class="device-table">
            <thead>
              <tr>
                <th>Time</th>
                <th>Role</th>
                <th>Action</th>
                <th>Details</th>
              </tr>
            </thead>
            <tbody id="auditTableBody">
              <tr class="empty-row">
                <td colspan="4">No audit entries yet.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>
    </main>

    <script src="config.js"></script>
    <script src="api.js"></script>
    <script src="app-permissions.js"></script>
    <script src="app-session.js"></script>
    <script src="audit-log.js"></script>
    <script>
      const auditTableBody = document.getElementById("auditTableBody");
      const clearAuditButton = document.getElementById("clearAuditButton");

      const formatAuditTimestamp = (value) => {
        if (!value) return "—";
        const date = new Date(value);
        if (Number.isNaN(date.getTime())) return "—";
        const months = [
          "Jan",
          "Feb",
          "Mar",
          "Apr",
          "May",
          "Jun",
          "Jul",
          "Aug",
          "Sep",
          "Oct",
          "Nov",
          "Dec",
        ];
        const day = String(date.getDate()).padStart(2, "0");
        const month = months[date.getMonth()];
        const year = date.getFullYear();
        const hours = String(date.getHours()).padStart(2, "0");
        const minutes = String(date.getMinutes()).padStart(2, "0");
        const seconds = String(date.getSeconds()).padStart(2, "0");
        return `${day}-${month}-${year} ${hours}:${minutes}:${seconds}`;
      };

      const renderAuditLogs = async () => {
        const logs = await window.auditLog.fetchAuditLogs();
        auditTableBody.innerHTML = "";
        if (!logs.length) {
          auditTableBody.innerHTML = `
            <tr class="empty-row">
              <td colspan="4">No audit entries yet.</td>
            </tr>
          `;
          return;
        }

        logs.forEach((entry) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${formatAuditTimestamp(entry.created_at)}</td>
            <td>${entry.role || "—"}</td>
            <td>${entry.action}</td>
            <td>${entry.details || "—"}</td>
          `;
          auditTableBody.appendChild(row);
        });
      };

      clearAuditButton.addEventListener("click", async () => {
        await window.auditLog.clearAuditLogs();
        renderAuditLogs();
      });

      renderAuditLogs();
    </script>
      <script src="loader.js"></script>
  </body>
</html>
