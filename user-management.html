<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User Management</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <header class="topbar">
      <div class="brand">
        <span class="brand-name">Asset Tracking</span>
      </div>
      <nav class="topbar-nav">
        <a href="index.html" data-nav="store">Store</a>
        <a href="phone.html" data-nav="phones">Phones</a>
        <a href="location-list.html" data-permission="location_list" data-nav="location-list">
          Location list
        </a>
        <a href="user-management.html" data-permission="user_management" data-nav="user-management">
          User management
        </a>
        <a href="audit-log.html" data-permission="user_management" data-nav="audit-log">Audit log</a>
      </nav>
      <div class="topbar-actions">
        <button class="icon-button" type="button" aria-label="Search">
          ⌕
        </button>
        <div class="user-menu">
          <button class="user-chip user-chip-button" type="button" data-user-menu-toggle>
            <span class="user-label">User</span>
            <span class="user-name" data-current-user>Guest</span>
            <span class="user-caret">▾</span>
          </button>
          <div class="user-dropdown" data-user-menu>
            <a class="dropdown-link" href="logout.html" data-logout-link>Logout</a>
          </div>
        </div>
      </div>
    </header>

    <main class="dashboard">
      <section class="hero-store">
        <div>
          <p class="hero-kicker">Administration</p>
          <h1>User management</h1>
          <p class="subtitle">
            Select a role to control which functions are enabled.
          </p>
        </div>
      </section>

      <section class="form-card">
        <div class="list-header">
          <div>
            <h2>Role permissions</h2>
            <p class="subtitle">
              Choose a role and check the functions to allow.
            </p>
          </div>
        </div>
        <form class="role-permissions-form" id="rolePermissionsForm">
          <label>
            <span>Role</span>
            <select id="rolePermissionSelect">
              <option value="Admin">Admin</option>
              <option value="Supervisor">Supervisor</option>
              <option value="Operator">Operator</option>
              <option value="Viewer">Viewer</option>
            </select>
          </label>
          <div class="permission-checklist" id="permissionChecklist">
            <label class="check-item">
              <input type="checkbox" value="register_device" checked />
              <span>Register device</span>
            </label>
            <label class="check-item">
              <input type="checkbox" value="issuing_personal" checked />
              <span>Assign phones (Personal)</span>
            </label>
            <label class="check-item">
              <input type="checkbox" value="issuing_shared" checked />
              <span>Assign phones (Shared)</span>
            </label>
            <label class="check-item">
              <input type="checkbox" value="bulk_issuing" checked />
              <span>Bulk issuing</span>
            </label>
            <label class="check-item">
              <input type="checkbox" value="returning" checked />
              <span>Returning</span>
            </label>
            <label class="check-item">
              <input type="checkbox" value="user_management" checked />
              <span>User management</span>
            </label>
          </div>
          <div class="form-actions">
            <button
              class="primary-button"
              type="submit"
              id="savePermissionsBtn"
              disabled
            >
              Save permissions
            </button>
          </div>
        </form>
      </section>

      <section class="form-card">
        <div class="list-header">
          <div>
            <h2>Users</h2>
            <p class="subtitle">Add users and assign roles.</p>
          </div>
        </div>
        <form class="asset-form user-form" id="userForm">
          <label>
            <span>Email</span>
            <input
              type="email"
              name="username"
              placeholder="e.g. alex.tan@company.com"
            />
          </label>
          <label>
            <span>Role</span>
            <select name="role">
              <option value="Admin">Admin</option>
              <option value="Supervisor">Supervisor</option>
              <option value="Operator">Operator</option>
              <option value="Viewer">Viewer</option>
            </select>
          </label>
          <label>
            <span>Password</span>
            <input type="password" name="password" placeholder="Set password" />
          </label>
          <fieldset class="location-group">
            <legend>Locations</legend>
            <div class="permission-checklist location-grid" id="locationChecklist">
              <label class="check-item">
                <input type="checkbox" value="Terminal 1" />
                <span>Terminal 1</span>
              </label>
              <label class="check-item">
                <input type="checkbox" value="Terminal 2" />
                <span>Terminal 2</span>
              </label>
              <label class="check-item">
                <input type="checkbox" value="Terminal 3" />
                <span>Terminal 3</span>
              </label>
              <label class="check-item">
                <input type="checkbox" value="Terminal 4" />
                <span>Terminal 4</span>
              </label>
              <label class="check-item">
                <input type="checkbox" value="Selatar" />
                <span>Selatar</span>
              </label>
              <label class="check-item">
                <input type="checkbox" value="HR and Admin" />
                <span>HR and Admin</span>
              </label>
            </div>
          </fieldset>
          <div class="form-actions">
            <button class="primary-button" type="submit">Add user</button>
          </div>
        </form>
        <div class="table-wrap">
          <table class="device-table">
            <thead>
              <tr>
                <th>Email</th>
                <th>Role</th>
                <th>Locations</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="userTableBody">
              <tr class="empty-row">
                <td colspan="4">No users created yet.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

    </main>

    <script src="config.js"></script>
    <script src="api.js"></script>
    <script src="app-permissions.js"></script>
    <script src="app-session.js"></script>
    <script src="audit-log.js"></script>
    <script>
      const rolePermissionSelect = document.getElementById(
        "rolePermissionSelect"
      );
      const permissionChecklist = document.getElementById(
        "permissionChecklist"
      );
      const locationChecklist = document.getElementById("locationChecklist");
      const rolePermissionsForm = document.getElementById(
        "rolePermissionsForm"
      );
      const savePermissionsBtn = document.getElementById("savePermissionsBtn");
      const userForm = document.getElementById("userForm");
      const userTableBody = document.getElementById("userTableBody");

      const PERMISSIONS = [
        { key: "register_device", label: "Register device" },
        { key: "issuing_personal", label: "Assign phones (Personal)" },
        { key: "issuing_shared", label: "Assign phones (Shared)" },
        { key: "bulk_issuing", label: "Bulk issuing" },
        { key: "returning", label: "Returning" },
        { key: "location_list", label: "Location list" },
        { key: "user_management", label: "User management" },
      ];

      const DEFAULT_ROLE_PERMISSIONS = {
        Admin: [
          "register_device",
          "issuing_personal",
          "issuing_shared",
          "bulk_issuing",
          "returning",
          "location_list",
          "user_management",
        ],
        Supervisor: [
          "register_device",
          "issuing_personal",
          "issuing_shared",
          "bulk_issuing",
          "returning",
          "location_list",
        ],
        Operator: [
          "issuing_personal",
          "issuing_shared",
          "returning",
          "location_list",
        ],
        Viewer: [],
      };

      let rolePermissions = null;

      const ensureAuth = () => {
        if (!window.assetTrackingApi?.getToken()) {
          window.location.href = "login.html";
          return false;
        }
        return true;
      };

      const loadRolePermissions = async () => {
        rolePermissions =
          (await window.assetTrackingPermissions?.resolve?.()) ||
          DEFAULT_ROLE_PERMISSIONS;
      };

      const renderPermissionChecklist = (role) => {
        permissionChecklist.innerHTML = "";
        const allowed = new Set((rolePermissions || {})[role] || []);

        PERMISSIONS.forEach((permission) => {
          const wrapper = document.createElement("label");
          wrapper.className = "check-item";
          wrapper.innerHTML = `
            <input type="checkbox" value="${permission.key}" ${
              allowed.has(permission.key) ? "checked" : ""
            } />
            <span>${permission.label}</span>
          `;
          permissionChecklist.appendChild(wrapper);
        });
        permissionChecklist.dataset.initialSignature = getChecklistSignature();
        updateSaveState();
      };

      rolePermissionSelect.addEventListener("change", () => {
        renderPermissionChecklist(rolePermissionSelect.value);
      });

      const getChecklistState = () =>
        Array.from(permissionChecklist.querySelectorAll("input")).map(
          (input) => ({
            key: input.value,
            checked: input.checked,
          })
        );

      const getChecklistSignature = () =>
        JSON.stringify(getChecklistState());

      const updateSaveState = () => {
        const initialSignature =
          permissionChecklist.dataset.initialSignature || "";
        const currentSignature = getChecklistSignature();
        if (!initialSignature) {
          permissionChecklist.dataset.initialSignature = currentSignature;
          savePermissionsBtn.disabled = true;
          return;
        }
        savePermissionsBtn.disabled = initialSignature === currentSignature;
      };

      permissionChecklist.addEventListener("change", updateSaveState);
      permissionChecklist.addEventListener("input", updateSaveState);
      permissionChecklist.addEventListener("click", updateSaveState);

      rolePermissionsForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        if (!ensureAuth()) return;
        const selectedRole = rolePermissionSelect.value;
        const checked = Array.from(
          permissionChecklist.querySelectorAll("input:checked")
        ).map((input) => input.value);
        try {
          await window.assetTrackingApi.apiFetch(
            `/api/role-permissions/${encodeURIComponent(selectedRole)}`,
            {
              method: "PUT",
              body: JSON.stringify({ permissions: checked }),
            }
          );
          rolePermissions = rolePermissions || {};
          rolePermissions[selectedRole] = checked;
        } catch (error) {
          return;
        }
        savePermissionsBtn.disabled = true;
      });

      const renderUsers = (users) => {
        userTableBody.innerHTML = "";
        if (!users.length) {
          userTableBody.innerHTML = `
            <tr class="empty-row">
              <td colspan="4">No users created yet.</td>
            </tr>
          `;
          return;
        }

        users.forEach((user) => {
          const isActive = user.is_active !== false;
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${user.username}</td>
            <td>${user.role}</td>
            <td>${user.location || "—"}</td>
            <td>
              <button
                class="status-toggle ${isActive ? "" : "is-inactive"}"
                type="button"
                data-user-id="${user.id}"
              >
                ${isActive ? "Active" : "Inactive"}
              </button>
            </td>
          `;
          userTableBody.appendChild(row);
        });
      };

      const loadUsers = async () => {
        const data = await window.assetTrackingApi.apiFetch("/api/users");
        return data.users || [];
      };

      userForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        if (!ensureAuth()) return;
        const formData = new FormData(userForm);
        const username = String(formData.get("username") || "").trim();
        const role = String(formData.get("role") || "").trim();
        const locations = Array.from(
          locationChecklist.querySelectorAll("input:checked")
        ).map((input) => input.value);
        const location = locations.join(", ");
        const password = String(formData.get("password") || "").trim();

        if (!username || !role || !password) {
          return;
        }

        try {
          const displayName = username.split("@")[0] || username;
          await window.assetTrackingApi.apiFetch("/api/users", {
            method: "POST",
            body: JSON.stringify({
              name: displayName,
              username,
              role,
              location,
              password,
            }),
          });
          const users = await loadUsers();
          renderUsers(users);
          userForm.reset();
          locationChecklist
            .querySelectorAll("input")
            .forEach((input) => (input.checked = false));
        } catch (error) {
          return;
        }
      });

      userTableBody.addEventListener("click", async (event) => {
        const target = event.target;
        if (!(target instanceof HTMLButtonElement)) {
          return;
        }

        const userId = target.getAttribute("data-user-id");
        if (!userId) {
          return;
        }

        if (!ensureAuth()) return;
        try {
          const nextState = target.textContent.trim() !== "Active";
          await window.assetTrackingApi.apiFetch(
            `/api/users/${encodeURIComponent(userId)}/status`,
            {
              method: "PATCH",
              body: JSON.stringify({ isActive: nextState }),
            }
          );
          const users = await loadUsers();
          renderUsers(users);
        } catch (error) {
          return;
        }
      });

      const initPage = async () => {
        if (!ensureAuth()) return;
        await loadRolePermissions();
        renderPermissionChecklist(rolePermissionSelect.value);
        const users = await loadUsers();
        renderUsers(users);
      };

      initPage();
    </script>
  </body>
</html>
