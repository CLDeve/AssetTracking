<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User Management</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <header class="topbar">
      <div class="brand">
        <span class="brand-name">Asset Tracking</span>
      </div>
      <nav class="topbar-nav">
        <a href="index.html" data-nav="store">Store</a>
        <a href="phone.html" data-nav="phones">Phones</a>
        <a href="user-management.html" data-permission="admin_user_management" data-nav="user-management">
          User management
        </a>
        <a href="audit-log.html" data-permission="admin_audit_log" data-nav="audit-log">Audit log</a>
      </nav>
      <div class="topbar-actions">
        <button class="icon-button" type="button" aria-label="Search">
          ⌕
        </button>
        <div class="user-menu">
          <button class="user-chip user-chip-button" type="button" data-user-menu-toggle>
            <span class="user-label">User</span>
            <span class="user-name" data-current-user>Guest</span>
            <span class="user-caret">▾</span>
          </button>
          <div class="user-dropdown" data-user-menu>
            <a class="dropdown-link" href="logout.html" data-logout-link>Logout</a>
          </div>
        </div>
      </div>
    </header>

    <main class="dashboard">
      <section class="hero-store">
        <div>
          <p class="hero-kicker">Administration</p>
          <h1>User management</h1>
          <p class="subtitle">
            Select a role to control which functions are enabled.
          </p>
        </div>
      </section>

      <section class="form-card">
        <div class="list-header">
          <div>
            <h2>Role permissions</h2>
            <p class="subtitle">
              Choose a role and check the functions to allow.
            </p>
          </div>
        </div>
        <form class="role-permissions-form" id="rolePermissionsForm">
          <label>
            <span>Role</span>
            <select id="rolePermissionSelect">
              <option value="Admin">Admin</option>
              <option value="Supervisor">Supervisor</option>
              <option value="Operator">Operator</option>
              <option value="Viewer">Viewer</option>
            </select>
          </label>
          <div class="permission-checklist" id="permissionChecklist">
            <label class="check-item">
              <input type="checkbox" value="register_device" checked />
              <span>Register device</span>
            </label>
            <label class="check-item">
              <input type="checkbox" value="issuing_personal" checked />
              <span>Assign phones (Personal)</span>
            </label>
            <label class="check-item">
              <input type="checkbox" value="issuing_shared" checked />
              <span>Assign phones (Shared)</span>
            </label>
            <label class="check-item">
              <input type="checkbox" value="bulk_issuing" checked />
              <span>Bulk issuing</span>
            </label>
            <label class="check-item">
              <input type="checkbox" value="returning" checked />
              <span>Returning</span>
            </label>
            <label class="check-item">
              <input type="checkbox" value="user_management" checked />
              <span>User management</span>
            </label>
          </div>
          <div class="form-actions">
            <button
              class="primary-button"
              type="submit"
              id="savePermissionsBtn"
              disabled
            >
              Save permissions
            </button>
          </div>
        </form>
      </section>

      <section class="form-card">
        <div class="list-header">
          <div>
            <h2>Users</h2>
            <p class="subtitle">Add users and assign roles.</p>
          </div>
        </div>
        <form class="asset-form user-form" id="userForm">
          <label>
            <span>Email</span>
            <input
              type="email"
              name="username"
              required
              placeholder="e.g. alex.tan@company.com"
            />
          </label>
          <label>
            <span>Role</span>
            <select name="role" required>
              <option value="Admin">Admin</option>
              <option value="Supervisor">Supervisor</option>
              <option value="Operator">Operator</option>
              <option value="Viewer">Viewer</option>
            </select>
          </label>
          <label>
            <span>Password</span>
            <input
              type="password"
              name="password"
              placeholder="Set password"
              required
            />
          </label>
          <fieldset class="location-group">
            <legend>Locations</legend>
            <div class="permission-checklist location-grid" id="locationChecklist">
              <label class="check-item">
                <input type="checkbox" value="Terminal 1" />
                <span>Terminal 1</span>
              </label>
              <label class="check-item">
                <input type="checkbox" value="Terminal 2" />
                <span>Terminal 2</span>
              </label>
              <label class="check-item">
                <input type="checkbox" value="Terminal 3" />
                <span>Terminal 3</span>
              </label>
              <label class="check-item">
                <input type="checkbox" value="Terminal 4" />
                <span>Terminal 4</span>
              </label>
              <label class="check-item">
                <input type="checkbox" value="Selatar" />
                <span>Selatar</span>
              </label>
              <label class="check-item">
                <input type="checkbox" value="HR and Admin" />
                <span>HR and Admin</span>
              </label>
            </div>
          </fieldset>
          <div class="form-actions">
            <button class="primary-button" type="submit" id="addUserButton" disabled>
              Add user
            </button>
          </div>
        </form>
        <div class="table-wrap">
          <table class="device-table">
            <thead>
              <tr>
                <th>Email</th>
                <th>Role</th>
                <th>Locations</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="userTableBody">
              <tr class="empty-row">
                <td colspan="4">No users created yet.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

    </main>

    <script src="config.js"></script>
    <script src="api.js"></script>
    <script src="app-permissions.js"></script>
    <script src="app-session.js"></script>
    <script src="audit-log.js"></script>
    <script>
      const rolePermissionSelect = document.getElementById(
        "rolePermissionSelect"
      );
      const permissionChecklist = document.getElementById(
        "permissionChecklist"
      );
      const locationChecklist = document.getElementById("locationChecklist");
      const rolePermissionsForm = document.getElementById(
        "rolePermissionsForm"
      );
      const savePermissionsBtn = document.getElementById("savePermissionsBtn");
      const userForm = document.getElementById("userForm");
      const addUserButton = document.getElementById("addUserButton");
      const userTableBody = document.getElementById("userTableBody");

      const PERMISSION_GROUPS = [
        {
          key: "store",
          label: "Store",
          children: [
            {
              key: "store_phone",
              label: "Phone",
              children: [
                { key: "phone_register_device", label: "Register a device" },
                { key: "phone_location_list", label: "Location list" },
                { key: "phone_returning", label: "Returning" },
                { key: "phone_issuing", label: "Issuing" },
              ],
            },
            { key: "store_tablet", label: "Tablet" },
            { key: "store_camera", label: "Body Worn Camera" },
          ],
        },
        {
          key: "admin",
          label: "Administration",
          children: [
            { key: "admin_user_management", label: "User management" },
            { key: "admin_audit_log", label: "Audit log" },
          ],
        },
      ];

      const DEFAULT_ROLE_PERMISSIONS = {
        Admin: [
          "store",
          "store_phone",
          "phone_register_device",
          "phone_location_list",
          "phone_returning",
          "phone_issuing",
          "store_tablet",
          "store_camera",
          "admin",
          "admin_user_management",
          "admin_audit_log",
        ],
        Supervisor: [
          "store",
          "store_phone",
          "phone_register_device",
          "phone_location_list",
          "phone_returning",
          "phone_issuing",
          "store_tablet",
          "store_camera",
        ],
        Operator: [
          "store",
          "store_phone",
          "phone_location_list",
          "phone_returning",
          "phone_issuing",
        ],
        Viewer: ["store"],
      };

      let rolePermissions = null;

      const ensureAuth = () => {
        if (!window.assetTrackingApi?.getToken()) {
          window.location.href = "login.html";
          return false;
        }
        return true;
      };

      const loadRolePermissions = async () => {
        rolePermissions =
          (await window.assetTrackingPermissions?.resolve?.()) ||
          DEFAULT_ROLE_PERMISSIONS;
      };

      const renderPermissionItem = (permission, allowed, depth = 0) => {
        const wrapper = document.createElement("div");
        wrapper.className = "permission-row";
        if (depth > 0) {
          wrapper.classList.add("is-nested");
        }

        wrapper.innerHTML = `
          <label class="check-item">
            <input type="checkbox" value="${permission.key}" data-permission-key="${permission.key}" ${
              allowed.has(permission.key) ? "checked" : ""
            } />
            <span>${permission.label}</span>
          </label>
        `;

        if (permission.children && permission.children.length) {
          const childContainer = document.createElement("div");
          childContainer.className = "permission-children";
          permission.children.forEach((child) => {
            childContainer.appendChild(
              renderPermissionItem(child, allowed, depth + 1)
            );
          });
          wrapper.appendChild(childContainer);
        }

        return wrapper;
      };

      const renderPermissionChecklist = (role) => {
        permissionChecklist.innerHTML = "";
        const allowed = new Set((rolePermissions || {})[role] || []);
        PERMISSION_GROUPS.forEach((group) => {
          permissionChecklist.appendChild(renderPermissionItem(group, allowed));
        });
        updateParentStates();
        permissionChecklist.dataset.initialSignature = getChecklistSignature();
        updateSaveState();
      };

      rolePermissionSelect.addEventListener("change", () => {
        renderPermissionChecklist(rolePermissionSelect.value);
      });

      const getChecklistState = () =>
        Array.from(permissionChecklist.querySelectorAll("input")).map(
          (input) => ({
            key: input.value,
            checked: input.checked,
          })
        );

      const getChecklistSignature = () =>
        JSON.stringify(getChecklistState());

      const updateSaveState = () => {
        const initialSignature =
          permissionChecklist.dataset.initialSignature || "";
        const currentSignature = getChecklistSignature();
        if (!initialSignature) {
          permissionChecklist.dataset.initialSignature = currentSignature;
          savePermissionsBtn.disabled = true;
          return;
        }
        savePermissionsBtn.disabled = initialSignature === currentSignature;
      };

      permissionChecklist.addEventListener("change", updateSaveState);
      permissionChecklist.addEventListener("input", updateSaveState);
      permissionChecklist.addEventListener("click", updateSaveState);

      const getCheckbox = (key) =>
        permissionChecklist.querySelector(
          `input[data-permission-key="${key}"]`
        );

      const updateParentStates = () => {
        const walk = (node) => {
          if (!node.children || !node.children.length) {
            return;
          }
          node.children.forEach(walk);
          const parentInput = getCheckbox(node.key);
          if (!parentInput) return;
          const childInputs = node.children
            .map((child) => getCheckbox(child.key))
            .filter(Boolean);
          const checkedCount = childInputs.filter((input) => input.checked)
            .length;
          parentInput.checked = checkedCount === childInputs.length;
          parentInput.indeterminate =
            checkedCount > 0 && checkedCount < childInputs.length;
        };

        PERMISSION_GROUPS.forEach(walk);
      };

      const setChildrenChecked = (node, checked) => {
        if (!node.children || !node.children.length) {
          return;
        }
        node.children.forEach((child) => {
          const input = getCheckbox(child.key);
          if (input) {
            input.checked = checked;
          }
          setChildrenChecked(child, checked);
        });
      };

      permissionChecklist.addEventListener("change", (event) => {
        const target = event.target;
        if (!(target instanceof HTMLInputElement)) {
          return;
        }
        const key = target.getAttribute("data-permission-key");
        if (!key) return;

        const findNode = (nodes, match) => {
          for (const node of nodes) {
            if (node.key === match) return node;
            if (node.children) {
              const found = findNode(node.children, match);
              if (found) return found;
            }
          }
          return null;
        };

        const node = findNode(PERMISSION_GROUPS, key);
        if (!node) return;
        if (node.children && node.children.length) {
          setChildrenChecked(node, target.checked);
        }
        updateParentStates();
        updateSaveState();
      });

      rolePermissionsForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        if (!ensureAuth()) return;
        const selectedRole = rolePermissionSelect.value;
        const checked = Array.from(
          permissionChecklist.querySelectorAll("input:checked")
        ).map((input) => input.value);
        const withParents = new Set(checked);

        const addParentsForChecked = (node) => {
          if (!node.children || !node.children.length) {
            return withParents.has(node.key);
          }
          const childChecked = node.children.some((child) =>
            addParentsForChecked(child)
          );
          if (childChecked) {
            withParents.add(node.key);
          }
          return childChecked;
        };

        PERMISSION_GROUPS.forEach(addParentsForChecked);
        try {
          await window.assetTrackingApi.apiFetch(
            `/api/role-permissions/${encodeURIComponent(selectedRole)}`,
            {
              method: "PUT",
              body: JSON.stringify({ permissions: Array.from(withParents) }),
            }
          );
          rolePermissions = rolePermissions || {};
          rolePermissions[selectedRole] = Array.from(withParents);
        } catch (error) {
          return;
        }
        savePermissionsBtn.disabled = true;
      });

      const renderUsers = (users) => {
        userTableBody.innerHTML = "";
        if (!users.length) {
          userTableBody.innerHTML = `
            <tr class="empty-row">
              <td colspan="4">No users created yet.</td>
            </tr>
          `;
          return;
        }

        users.forEach((user) => {
          const isActive = user.is_active !== false;
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${user.username}</td>
            <td>${user.role}</td>
            <td>${user.location || "—"}</td>
            <td>
              <button
                class="status-toggle ${isActive ? "" : "is-inactive"}"
                type="button"
                data-user-id="${user.id}"
              >
                ${isActive ? "Active" : "Inactive"}
              </button>
            </td>
          `;
          userTableBody.appendChild(row);
        });
      };

      const loadUsers = async () => {
        const data = await window.assetTrackingApi.apiFetch("/api/users");
        return data.users || [];
      };

      userForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        if (!ensureAuth()) return;
        const formData = new FormData(userForm);
        const username = String(formData.get("username") || "").trim();
        const role = String(formData.get("role") || "").trim();
        const locations = Array.from(
          locationChecklist.querySelectorAll("input:checked")
        ).map((input) => input.value);
        const location = locations.join(", ");
        const password = String(formData.get("password") || "").trim();

        if (!username || !role || !password) {
          return;
        }

        try {
          const displayName = username.split("@")[0] || username;
          await window.assetTrackingApi.apiFetch("/api/users", {
            method: "POST",
            body: JSON.stringify({
              name: displayName,
              username,
              role,
              location,
              password,
            }),
          });
          const users = await loadUsers();
          renderUsers(users);
          userForm.reset();
          locationChecklist
            .querySelectorAll("input")
            .forEach((input) => (input.checked = false));
          updateUserSubmitState();
        } catch (error) {
          return;
        }
      });

      const updateUserSubmitState = () => {
        const formData = new FormData(userForm);
        const username = String(formData.get("username") || "").trim();
        const role = String(formData.get("role") || "").trim();
        const password = String(formData.get("password") || "").trim();
        const locationsSelected =
          locationChecklist.querySelectorAll("input:checked").length > 0;
        const valid =
          Boolean(username) && Boolean(role) && Boolean(password) && locationsSelected;
        addUserButton.disabled = !valid;
      };

      userForm.addEventListener("input", updateUserSubmitState);
      userForm.addEventListener("change", updateUserSubmitState);
      updateUserSubmitState();

      userTableBody.addEventListener("click", async (event) => {
        const target = event.target;
        if (!(target instanceof HTMLButtonElement)) {
          return;
        }

        const userId = target.getAttribute("data-user-id");
        if (!userId) {
          return;
        }

        if (!ensureAuth()) return;
        try {
          const nextState = target.textContent.trim() !== "Active";
          await window.assetTrackingApi.apiFetch(
            `/api/users/${encodeURIComponent(userId)}/status`,
            {
              method: "PATCH",
              body: JSON.stringify({ isActive: nextState }),
            }
          );
          const users = await loadUsers();
          renderUsers(users);
        } catch (error) {
          return;
        }
      });

      const initPage = async () => {
        if (!ensureAuth()) return;
        await loadRolePermissions();
        renderPermissionChecklist(rolePermissionSelect.value);
        const users = await loadUsers();
        renderUsers(users);
      };

      initPage();
    </script>
  </body>
</html>
