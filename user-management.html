<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User Management</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
  <div class="page-loader" data-page-loader>
    <div class="spinner" aria-label="Loading" role="status"></div>
  </div>
<header class="topbar">
      <div class="brand">
        <span class="brand-name">Asset Tracking</span>
      </div>
          <nav class="topbar-nav">
        <a href="index.html" data-nav="store" data-permission="store">Store</a>
        <a href="phone.html" data-nav="phones" data-permission="store_phone">Phones</a>        <a href="user-management.html" data-permission="admin_user_management" data-nav="user-management">
          User management
        </a>
        <a href="audit-log.html" data-permission="admin_audit_log" data-nav="audit-log">Audit log</a>
      </nav>
      <div class="topbar-actions">
        <button class="icon-button" type="button" aria-label="Search">
          ⌕
        </button>
        <div class="user-menu">
          <button class="user-chip user-chip-button" type="button" data-user-menu-toggle>
            <span class="user-label">User</span>
            <span class="user-name" data-current-user>Guest</span>
            <span class="user-caret">▾</span>
          </button>
          <div class="user-dropdown" data-user-menu>
            <a class="dropdown-link" href="logout.html" data-logout-link>Logout</a>
          </div>
        </div>
      </div>
    </header>

    <main class="dashboard">
      <section class="hero-store">
        <div>
          <p class="hero-kicker">Administration</p>
          <h1>User management</h1>
          <p class="subtitle">
            Select a role to control which functions are enabled.
          </p>
        </div>
      </section>

      <section class="form-card">
        <div class="list-header">
          <div>
            <h2>Create role</h2>
            <p class="subtitle">Add a new role for permissions and users.</p>
          </div>
        </div>
        <div class="role-create">
          <label>
            <span>New role</span>
            <input
              type="text"
              id="newRoleInput"
              placeholder="e.g. T2 Supervisor"
              autocomplete="off"
            />
          </label>
          <button
            class="secondary-button"
            type="button"
            id="addRoleButton"
            disabled
          >
            Add role
          </button>
        </div>
      </section>

      <section class="form-card">
        <div class="list-header">
          <div>
            <h2>Role permissions</h2>
            <p class="subtitle">
              Choose a role and check the functions to allow.
            </p>
          </div>
        </div>
        <form class="role-permissions-form" id="rolePermissionsForm">
          <div class="role-permissions-toolbar">
            <label class="role-select">
              <span>Role</span>
              <select id="rolePermissionSelect" name="rolePermission" required></select>
            </label>
            <div class="role-permissions-actions">
              <button
                class="primary-button"
                type="submit"
                id="savePermissionsBtn"
                disabled
              >
                Save permissions
              </button>
            </div>
          </div>
          <p class="role-permissions-hint">
            Changes apply immediately for the selected role.
          </p>
          <p class="form-message" id="rolePermissionsMessage" role="status"></p>
          <div class="permission-checklist" id="permissionChecklist">
            <label class="check-item">
              <input type="checkbox" value="register_device" checked />
              <span>Register device</span>
            </label>
            <label class="check-item">
              <input type="checkbox" value="phone_issuing_personal" checked />
              <span>Assign phones (Personal)</span>
            </label>
            <label class="check-item">
              <input type="checkbox" value="phone_issuing_shared" checked />
              <span>Assign phones (Shared)</span>
            </label>
            <label class="check-item">
              <input type="checkbox" value="phone_issuing_bulk" checked />
              <span>Bulk issuing</span>
            </label>
            <label class="check-item">
              <input type="checkbox" value="returning" checked />
              <span>Returning</span>
            </label>
            <label class="check-item">
              <input type="checkbox" value="user_management" checked />
              <span>User management</span>
            </label>
          </div>
        </form>
      </section>

      <section class="form-card">
        <div class="list-header">
          <div>
            <h2>Users</h2>
            <p class="subtitle">Add users and assign roles.</p>
          </div>
        </div>
        <form class="asset-form user-form" id="userForm">
          <label>
            <span>Email</span>
            <input
              type="email"
              name="username"
              required
              placeholder="e.g. alex.tan@company.com"
            />
          </label>
          <label>
            <span>Role</span>
            <select name="role" required></select>
          </label>
          <label>
            <span>Password</span>
            <div class="password-field">
              <input
                type="password"
                name="password"
                placeholder="Set password"
                required
                data-password-input
              />
              <button
                class="password-toggle"
                type="button"
                data-password-toggle
                aria-label="Show password"
              >
                Show
              </button>
            </div>
          </label>
          <fieldset class="location-group">
            <legend>Locations</legend>
            <div class="permission-checklist location-grid" id="locationChecklist">
              <label class="check-item">
                <input type="checkbox" value="Terminal 1" />
                <span>Terminal 1</span>
              </label>
              <label class="check-item">
                <input type="checkbox" value="Terminal 2" />
                <span>Terminal 2</span>
              </label>
              <label class="check-item">
                <input type="checkbox" value="Terminal 3" />
                <span>Terminal 3</span>
              </label>
              <label class="check-item">
                <input type="checkbox" value="Terminal 4" />
                <span>Terminal 4</span>
              </label>
              <label class="check-item">
                <input type="checkbox" value="Selatar" />
                <span>Selatar</span>
              </label>
              <label class="check-item">
                <input type="checkbox" value="HR and Admin" />
                <span>HR and Admin</span>
              </label>
            </div>
          </fieldset>
          <div class="form-actions">
            <button class="primary-button" type="submit" id="addUserButton" disabled>
              Add user
            </button>
          </div>
        </form>
        <div class="table-wrap">
          <table class="device-table">
            <thead>
              <tr>
                <th>Email</th>
                <th>Role</th>
                <th>Locations</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="userTableBody">
              <tr class="empty-row">
                <td colspan="5">No users created yet.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <div class="modal is-hidden" id="editUserModal" aria-hidden="true">
        <div class="modal-content">
          <div class="modal-header">
            <h2>Edit user</h2>
            <button class="icon-button" type="button" id="closeEditUserModal" aria-label="Close">
              ✕
            </button>
          </div>
          <form class="asset-form user-form" id="editUserForm">
            <label>
              <span>Email</span>
              <input
                type="email"
                name="username"
                required
                placeholder="e.g. alex.tan@company.com"
              />
            </label>
            <label>
              <span>Role</span>
              <select name="role" required></select>
            </label>
            <label>
              <span>Password (optional)</span>
              <div class="password-field">
                <input
                  type="password"
                  name="password"
                  placeholder="Leave blank to keep"
                  data-password-input
                />
                <button
                  class="password-toggle"
                  type="button"
                  data-password-toggle
                  aria-label="Show password"
                >
                  Show
                </button>
              </div>
            </label>
            <fieldset class="location-group">
              <legend>Locations</legend>
              <div class="permission-checklist location-grid" id="editLocationChecklist">
                <label class="check-item">
                  <input type="checkbox" value="Terminal 1" />
                  <span>Terminal 1</span>
                </label>
                <label class="check-item">
                  <input type="checkbox" value="Terminal 2" />
                  <span>Terminal 2</span>
                </label>
                <label class="check-item">
                  <input type="checkbox" value="Terminal 3" />
                  <span>Terminal 3</span>
                </label>
                <label class="check-item">
                  <input type="checkbox" value="Terminal 4" />
                  <span>Terminal 4</span>
                </label>
                <label class="check-item">
                  <input type="checkbox" value="Selatar" />
                  <span>Selatar</span>
                </label>
                <label class="check-item">
                  <input type="checkbox" value="HR and Admin" />
                  <span>HR and Admin</span>
                </label>
              </div>
            </fieldset>
            <div class="form-actions">
              <button class="secondary-button" type="button" id="cancelEditUser">
                Cancel
              </button>
              <button class="primary-button" type="submit" id="saveEditUser">
                Save changes
              </button>
            </div>
          </form>
        </div>
      </div>

    </main>

    <script src="config.js"></script>
    <script src="api.js"></script>
    <script src="app-permissions.js"></script>
    <script src="app-session.js"></script>
    <script src="audit-log.js"></script>
    <script>
      const rolePermissionSelect = document.getElementById(
        "rolePermissionSelect"
      );
      const newRoleInput = document.getElementById("newRoleInput");
      const addRoleButton = document.getElementById("addRoleButton");
      const permissionChecklist = document.getElementById(
        "permissionChecklist"
      );
      const locationChecklist = document.getElementById("locationChecklist");
      const editUserModal = document.getElementById("editUserModal");
      const editUserForm = document.getElementById("editUserForm");
      const editLocationChecklist = document.getElementById(
        "editLocationChecklist"
      );
      const closeEditUserModal = document.getElementById("closeEditUserModal");
      const cancelEditUser = document.getElementById("cancelEditUser");
      const rolePermissionsForm = document.getElementById(
        "rolePermissionsForm"
      );
      const savePermissionsBtn = document.getElementById("savePermissionsBtn");
      const rolePermissionsMessage = document.getElementById(
        "rolePermissionsMessage"
      );
      const userForm = document.getElementById("userForm");
      const addUserButton = document.getElementById("addUserButton");
      const userTableBody = document.getElementById("userTableBody");
      const userRoleSelect = userForm.querySelector('select[name="role"]');
      const editRoleSelect = editUserForm.querySelector('select[name="role"]');

      const PERMISSION_GROUPS = [
        {
          key: "store",
          label: "Store",
          children: [
            {
              key: "store_phone",
              label: "Phone",
              children: [
                { key: "phone_register_device", label: "Register a device" },
                { key: "phone_location_list", label: "Location list" },
                {
                  key: "phone_issuing",
                  label: "Issuing",
                  children: [
                    { key: "phone_issuing_personal", label: "Personal issue" },
                    { key: "phone_issuing_shared", label: "Shared issue" },
                    { key: "phone_issuing_bulk", label: "Bulk issuing" },
                  ],
                },
              ],
            },
            { key: "store_tablet", label: "Tablet" },
            { key: "store_camera", label: "Body Worn Camera" },
          ],
        },
        {
          key: "admin",
          label: "Administration",
          children: [
            { key: "admin_user_management", label: "User management" },
            { key: "admin_audit_log", label: "Audit log" },
          ],
        },
      ];

      const DEFAULT_ROLE_PERMISSIONS = {
        Admin: [
          "store",
          "store_phone",
          "phone_register_device",
          "phone_location_list",
          "phone_issuing",
          "phone_issuing_personal",
          "phone_issuing_shared",
          "phone_issuing_bulk",
          "store_tablet",
          "store_camera",
          "admin",
          "admin_user_management",
          "admin_audit_log",
        ],
        Supervisor: [
          "store",
          "store_phone",
          "phone_register_device",
          "phone_location_list",
          "phone_issuing",
          "phone_issuing_personal",
          "phone_issuing_shared",
          "phone_issuing_bulk",
          "store_tablet",
          "store_camera",
        ],
        Operator: [
          "store",
          "store_phone",
          "phone_location_list",
          "phone_issuing",
          "phone_issuing_personal",
          "phone_issuing_shared",
          "phone_issuing_bulk",
        ],
        Viewer: ["store"],
      };

      let rolePermissions = null;
      let customRoles = new Set();
      let cachedUsers = [];
      const ROLE_STORAGE_KEY = "assetTrackingRoleSelection";

      const normalizeRole = (value) => String(value || "").trim();
      const getStoredRole = () =>
        normalizeRole(localStorage.getItem(ROLE_STORAGE_KEY));
      const setStoredRole = (role) => {
        if (!role) {
          localStorage.removeItem(ROLE_STORAGE_KEY);
          return;
        }
        localStorage.setItem(ROLE_STORAGE_KEY, role);
      };

      const getAllRoles = (users = []) => {
        const roles = new Set(Object.keys(DEFAULT_ROLE_PERMISSIONS));
        customRoles.forEach((role) => roles.add(role));
        Object.keys(rolePermissions || {}).forEach((role) => roles.add(role));
        users.forEach((user) => {
          if (user?.role) {
            roles.add(user.role);
          }
        });
        return Array.from(roles).sort((a, b) => a.localeCompare(b));
      };

      const updateRoleSelect = (select, roles, fallbackRole) => {
        if (!select) return;
        const currentValue = normalizeRole(select.value);
        select.innerHTML = "";
        roles.forEach((role) => {
          const option = document.createElement("option");
          option.value = role;
          option.textContent = role;
          select.appendChild(option);
        });
        const nextValue = roles.includes(currentValue)
          ? currentValue
          : fallbackRole;
        select.value = nextValue || "";
      };

      const updateRoleOptions = (users = cachedUsers) => {
        cachedUsers = users;
        const roles = getAllRoles(users);
        const storedRole = getStoredRole();
        const fallbackRole = roles.includes(storedRole)
          ? storedRole
          : roles[0] || "Admin";
        updateRoleSelect(rolePermissionSelect, roles, fallbackRole);
        updateRoleSelect(userRoleSelect, roles, fallbackRole);
        updateRoleSelect(editRoleSelect, roles, fallbackRole);
        updateAddRoleState();
      };

      const updateAddRoleState = () => {
        if (!addRoleButton) return;
        const role = normalizeRole(newRoleInput?.value);
        const roles = getAllRoles(cachedUsers);
        addRoleButton.disabled = !role || roles.includes(role);
      };

      const ensureAuth = () => {
        if (!window.assetTrackingApi?.getToken()) {
          window.location.href = "login.html";
          return false;
        }
        return true;
      };

      const loadRolePermissions = async () => {
        rolePermissions =
          (await window.assetTrackingPermissions?.resolve?.()) ||
          DEFAULT_ROLE_PERMISSIONS;
      };

      const renderPermissionItem = (permission, allowed, depth = 0) => {
        const wrapper = document.createElement("div");
        wrapper.className = "permission-row";
        if (depth > 0) {
          wrapper.classList.add("is-nested");
        }
        if (depth === 0) {
          wrapper.classList.add("is-group");
        } else if (depth === 1) {
          wrapper.classList.add("is-subgroup");
        } else {
          wrapper.classList.add("is-leaf");
        }
        wrapper.dataset.depth = String(depth);

        wrapper.innerHTML = `
          <label class="check-item">
            <input type="checkbox" value="${permission.key}" data-permission-key="${permission.key}" ${
              allowed.has(permission.key) ? "checked" : ""
            } />
            <span>${permission.label}</span>
          </label>
        `;

        if (permission.children && permission.children.length) {
          const childContainer = document.createElement("div");
          childContainer.className = "permission-children";
          permission.children.forEach((child) => {
            childContainer.appendChild(
              renderPermissionItem(child, allowed, depth + 1)
            );
          });
          wrapper.appendChild(childContainer);
        }

        return wrapper;
      };

      const renderPermissionChecklist = (role) => {
        if (!normalizeRole(role)) {
          return;
        }
        permissionChecklist.innerHTML = "";
        const allowed = new Set((rolePermissions || {})[role] || []);
        PERMISSION_GROUPS.forEach((group) => {
          permissionChecklist.appendChild(renderPermissionItem(group, allowed));
        });
        updateParentStates();
        permissionChecklist.dataset.initialSignature = getChecklistSignature();
        updateSaveState();
      };

      rolePermissionSelect.addEventListener("change", () => {
        const role = normalizeRole(rolePermissionSelect.value);
        if (!role) return;
        setStoredRole(role);
        renderPermissionChecklist(role);
        if (rolePermissionsMessage) {
          rolePermissionsMessage.textContent = "";
          rolePermissionsMessage.className = "form-message";
        }
      });

      const addRole = () => {
        const role = normalizeRole(newRoleInput?.value);
        if (!role) return;
        customRoles.add(role);
        updateRoleOptions();
        rolePermissionSelect.value = role;
        setStoredRole(role);
        renderPermissionChecklist(role);
        if (newRoleInput) {
          newRoleInput.value = "";
        }
        updateAddRoleState();
      };

      if (newRoleInput) {
        newRoleInput.addEventListener("input", updateAddRoleState);
        newRoleInput.addEventListener("keydown", (event) => {
          if (event.key === "Enter") {
            event.preventDefault();
            addRole();
          }
        });
      }

      if (addRoleButton) {
        addRoleButton.addEventListener("click", addRole);
      }

      const getChecklistState = () =>
        Array.from(permissionChecklist.querySelectorAll("input")).map(
          (input) => ({
            key: input.value,
            checked: input.checked,
          })
        );

      const getChecklistSignature = () =>
        JSON.stringify(getChecklistState());

      const updateSaveState = () => {
        const initialSignature =
          permissionChecklist.dataset.initialSignature || "";
        const currentSignature = getChecklistSignature();
        if (!initialSignature) {
          permissionChecklist.dataset.initialSignature = currentSignature;
          savePermissionsBtn.disabled = true;
          return;
        }
        savePermissionsBtn.disabled = initialSignature === currentSignature;
      };

      permissionChecklist.addEventListener("change", updateSaveState);
      permissionChecklist.addEventListener("input", updateSaveState);
      permissionChecklist.addEventListener("click", updateSaveState);

      const getCheckbox = (key) =>
        permissionChecklist.querySelector(
          `input[data-permission-key="${key}"]`
        );

      const updateParentStates = () => {
        const walk = (node) => {
          if (!node.children || !node.children.length) {
            return;
          }
          node.children.forEach(walk);
          const parentInput = getCheckbox(node.key);
          if (!parentInput) return;
          const childInputs = node.children
            .map((child) => getCheckbox(child.key))
            .filter(Boolean);
          const checkedCount = childInputs.filter((input) => input.checked)
            .length;
          parentInput.checked = checkedCount === childInputs.length;
          parentInput.indeterminate =
            checkedCount > 0 && checkedCount < childInputs.length;
        };

        PERMISSION_GROUPS.forEach(walk);
      };

      const setChildrenChecked = (node, checked) => {
        if (!node.children || !node.children.length) {
          return;
        }
        node.children.forEach((child) => {
          const input = getCheckbox(child.key);
          if (input) {
            input.checked = checked;
          }
          setChildrenChecked(child, checked);
        });
      };

      permissionChecklist.addEventListener("change", (event) => {
        const target = event.target;
        if (!(target instanceof HTMLInputElement)) {
          return;
        }
        const key = target.getAttribute("data-permission-key");
        if (!key) return;

        const findNode = (nodes, match) => {
          for (const node of nodes) {
            if (node.key === match) return node;
            if (node.children) {
              const found = findNode(node.children, match);
              if (found) return found;
            }
          }
          return null;
        };

        const node = findNode(PERMISSION_GROUPS, key);
        if (!node) return;
        if (node.children && node.children.length) {
          setChildrenChecked(node, target.checked);
        }
        updateParentStates();
        updateSaveState();
      });

      rolePermissionsForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        if (!ensureAuth()) return;
        const selectedRole = normalizeRole(rolePermissionSelect.value);
        if (!selectedRole) {
          return;
        }
        const checked = Array.from(
          permissionChecklist.querySelectorAll("input:checked")
        ).map((input) => input.value);
        try {
          await window.assetTrackingApi.apiFetch(
            `/api/role-permissions/${encodeURIComponent(selectedRole)}`,
            {
              method: "PUT",
              body: JSON.stringify({ permissions: checked }),
            }
          );
          rolePermissions = rolePermissions || {};
          rolePermissions[selectedRole] = checked;
          customRoles.add(selectedRole);
          updateRoleOptions();
          if (rolePermissionsMessage) {
            rolePermissionsMessage.textContent = "Permissions saved.";
            rolePermissionsMessage.className = "form-message success";
          }
        } catch (error) {
          if (rolePermissionsMessage) {
            rolePermissionsMessage.textContent =
              error?.message || "Unable to save permissions.";
            rolePermissionsMessage.className = "form-message error";
          }
          return;
        }
        savePermissionsBtn.disabled = true;
      });

      const renderUsers = (users) => {
        userTableBody.innerHTML = "";
        if (!users.length) {
          userTableBody.innerHTML = `
            <tr class="empty-row">
              <td colspan="4">No users created yet.</td>
            </tr>
          `;
          return;
        }

        users.forEach((user) => {
          const isActive = user.is_active !== false;
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${user.username}</td>
            <td>${user.role}</td>
            <td>${user.location || "—"}</td>
            <td>
              <button
                class="status-toggle ${isActive ? "" : "is-inactive"}"
                type="button"
                data-user-id="${user.id}"
                data-action="toggle"
              >
                ${isActive ? "Active" : "Inactive"}
              </button>
            </td>
            <td>
              <button
                class="edit-button"
                type="button"
                data-user-id="${user.id}"
                data-action="edit"
              >
                Edit
              </button>
            </td>
          `;
          userTableBody.appendChild(row);
        });
      };

      const initPasswordToggles = () => {
        document.querySelectorAll("[data-password-toggle]").forEach((button) => {
          button.addEventListener("click", () => {
            const field = button.closest(".password-field");
            const input = field?.querySelector("[data-password-input]");
            if (!input) return;
            const nextType = input.type === "password" ? "text" : "password";
            input.type = nextType;
            const isVisible = nextType === "text";
            button.textContent = isVisible ? "Hide" : "Show";
            button.setAttribute(
              "aria-label",
              isVisible ? "Hide password" : "Show password"
            );
          });
        });
      };

      const loadUsers = async () => {
        const data = await window.assetTrackingApi.apiFetch("/api/users");
        return data.users || [];
      };

      userForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        if (!ensureAuth()) return;
        const formData = new FormData(userForm);
        const username = String(formData.get("username") || "").trim();
        const role = String(formData.get("role") || "").trim();
        const locations = Array.from(
          locationChecklist.querySelectorAll("input:checked")
        ).map((input) => input.value);
        const location = locations.join(", ");
        const password = String(formData.get("password") || "").trim();

        if (!username || !role || !password) {
          return;
        }

        if (!username.includes("@")) {
          return;
        }

        try {
          const displayName = username.split("@")[0] || username;
          await window.assetTrackingApi.apiFetch("/api/users", {
            method: "POST",
            body: JSON.stringify({
              name: displayName,
              username,
              role,
              location,
              password,
            }),
          });
          const users = await loadUsers();
          updateRoleOptions(users);
          renderUsers(users);
          userForm.reset();
          locationChecklist
            .querySelectorAll("input")
            .forEach((input) => (input.checked = false));
          updateUserSubmitState();
        } catch (error) {
          return;
        }
      });

      const updateUserSubmitState = () => {
        const formData = new FormData(userForm);
        const username = normalizeRole(formData.get("username"));
        const role = normalizeRole(formData.get("role"));
        const password = normalizeRole(formData.get("password"));
        const locationsSelected =
          locationChecklist.querySelectorAll("input:checked").length > 0;
        const validEmail = username.includes("@");
        const valid =
          Boolean(username) &&
          Boolean(role) &&
          Boolean(password) &&
          locationsSelected &&
          validEmail;
        addUserButton.disabled = !valid;
      };

      userForm.addEventListener("input", updateUserSubmitState);
      userForm.addEventListener("change", updateUserSubmitState);
      updateUserSubmitState();

      const parseLocations = (value) =>
        String(value || "")
          .split(",")
          .map((item) => item.trim())
          .filter(Boolean);

      let editingUserId = null;

      const openEditModal = (user) => {
        editingUserId = user.id;
        editUserForm.username.value = user.username || "";
        editUserForm.role.value = user.role || "";
        customRoles.add(user.role);
        updateRoleOptions();
        editUserForm.password.value = "";
        const locations = new Set(parseLocations(user.location));
        editLocationChecklist
          .querySelectorAll("input")
          .forEach((input) => {
            input.checked = locations.has(input.value);
          });
        editUserModal.classList.remove("is-hidden");
        editUserModal.setAttribute("aria-hidden", "false");
      };

      const closeEditModal = () => {
        editUserModal.classList.add("is-hidden");
        editUserModal.setAttribute("aria-hidden", "true");
        editUserForm.reset();
        editingUserId = null;
      };

      closeEditUserModal.addEventListener("click", closeEditModal);
      cancelEditUser.addEventListener("click", closeEditModal);

      editUserForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        if (!ensureAuth()) return;
        if (!editingUserId) return;

        const formData = new FormData(editUserForm);
        const username = String(formData.get("username") || "").trim();
        const role = String(formData.get("role") || "").trim();
        const password = String(formData.get("password") || "").trim();
        const locations = Array.from(
          editLocationChecklist.querySelectorAll("input:checked")
        ).map((input) => input.value);
        const location = locations.join(", ");
        if (!username || !role) {
          return;
        }
        if (!username.includes("@")) {
          return;
        }

        try {
          const displayName = username.split("@")[0] || username;
          const result = await window.assetTrackingApi.apiFetch(
            `/api/users/${encodeURIComponent(editingUserId)}`,
            {
              method: "PUT",
              body: JSON.stringify({
                name: displayName,
                username,
                role,
                location,
                password: password || undefined,
              }),
            }
          );
          const storedUser = window.assetTrackingApi.getStoredUser();
          if (storedUser && String(storedUser.id) === String(editingUserId)) {
            window.assetTrackingApi.setStoredUser(result.user);
          }
          const users = await loadUsers();
          updateRoleOptions(users);
          renderUsers(users);
          closeEditModal();
        } catch (error) {
          return;
        }
      });

      userTableBody.addEventListener("click", async (event) => {
        const target = event.target;
        if (!(target instanceof HTMLButtonElement)) {
          return;
        }

        const userId = target.getAttribute("data-user-id");
        const action = target.getAttribute("data-action");
        if (!userId) {
          return;
        }

        if (action === "edit") {
          const user = (await loadUsers()).find(
            (entry) => String(entry.id) === String(userId)
          );
          if (user) {
            openEditModal(user);
          }
          return;
        }

        if (action === "toggle") {
          if (!ensureAuth()) return;
          try {
            const nextState = target.textContent.trim() !== "Active";
            await window.assetTrackingApi.apiFetch(
              `/api/users/${encodeURIComponent(userId)}/status`,
              {
                method: "PATCH",
                body: JSON.stringify({ isActive: nextState }),
              }
            );
            const users = await loadUsers();
            renderUsers(users);
          } catch (error) {
            return;
          }
        }
      });

      const initPage = async () => {
        if (!ensureAuth()) return;
        initPasswordToggles();
        await loadRolePermissions();
        const users = await loadUsers();
        updateRoleOptions(users);
        renderPermissionChecklist(rolePermissionSelect.value);
        renderUsers(users);
        updateAddRoleState();
      };

      initPage();
    </script>
      <script src="loader.js"></script>
  </body>
</html>
