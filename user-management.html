<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User Management</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <header class="topbar">
      <div class="brand">
        <span class="brand-name">Asset Tracking</span>
      </div>
      <nav class="topbar-nav">
        <a href="index.html">Dashboard</a>
        <a href="phone.html">Phones</a>
        <a href="login.html">Login</a>
        <a href="location-list.html" data-permission="location_list">
          Location list
        </a>
        <a href="user-management.html" data-permission="user_management">
          User management
        </a>
      </nav>
      <div class="topbar-actions">
        <button class="icon-button" type="button" aria-label="Search">
          ⌕
        </button>
        <div class="user-chip">
          <span class="user-label">User</span>
          <span class="user-name" data-current-user>Guest</span>
        </div>
        <a class="text-link" href="logout.html" data-logout-link>Logout</a>
      </div>
    </header>

    <main class="dashboard">
      <section class="hero-store">
        <div>
          <p class="hero-kicker">Administration</p>
          <h1>User management</h1>
          <p class="subtitle">
            Select a role to control which functions are enabled.
          </p>
        </div>
      </section>

      <section class="form-card">
        <div class="list-header">
          <div>
            <h2>Role permissions</h2>
            <p class="subtitle">
              Choose a role and check the functions to allow.
            </p>
          </div>
        </div>
        <form class="role-permissions-form" id="rolePermissionsForm">
          <label>
            <span>Role</span>
            <select id="rolePermissionSelect">
              <option value="Admin">Admin</option>
              <option value="Supervisor">Supervisor</option>
              <option value="Operator">Operator</option>
              <option value="Viewer">Viewer</option>
            </select>
          </label>
          <div class="permission-checklist" id="permissionChecklist">
            <label class="check-item">
              <input type="checkbox" value="register_device" checked />
              <span>Register device</span>
            </label>
            <label class="check-item">
              <input type="checkbox" value="issuing_personal" checked />
              <span>Assign phones (Personal)</span>
            </label>
            <label class="check-item">
              <input type="checkbox" value="issuing_shared" checked />
              <span>Assign phones (Shared)</span>
            </label>
            <label class="check-item">
              <input type="checkbox" value="bulk_issuing" checked />
              <span>Bulk issuing</span>
            </label>
            <label class="check-item">
              <input type="checkbox" value="returning" checked />
              <span>Returning</span>
            </label>
            <label class="check-item">
              <input type="checkbox" value="user_management" checked />
              <span>User management</span>
            </label>
          </div>
          <div class="form-actions">
            <button
              class="primary-button"
              type="submit"
              id="savePermissionsBtn"
              disabled
            >
              Save permissions
            </button>
          </div>
        </form>
      </section>

      <section class="form-card">
        <div class="list-header">
          <div>
            <h2>Users</h2>
            <p class="subtitle">Add users and assign roles.</p>
          </div>
        </div>
        <form class="asset-form" id="userForm">
          <label>
            <span>Name</span>
            <input type="text" name="name" placeholder="e.g. Alex Tan" />
          </label>
          <label>
            <span>Username</span>
            <input type="text" name="username" placeholder="e.g. alex.tan" />
          </label>
          <label>
            <span>Role</span>
            <select name="role">
              <option value="Admin">Admin</option>
              <option value="Supervisor">Supervisor</option>
              <option value="Operator">Operator</option>
              <option value="Viewer">Viewer</option>
            </select>
          </label>
          <label>
            <span>Location</span>
            <select name="location">
              <option value="">Select location</option>
              <option value="Terminal 1">Terminal 1</option>
              <option value="Terminal 2">Terminal 2</option>
              <option value="Terminal 3">Terminal 3</option>
              <option value="Terminal 4">Terminal 4</option>
              <option value="Selatar">Selatar</option>
              <option value="HR and Admin">HR and Admin</option>
            </select>
          </label>
          <label>
            <span>Password</span>
            <input type="password" name="password" placeholder="Set password" />
          </label>
          <div class="form-actions">
            <button class="primary-button" type="submit">Add user</button>
          </div>
        </form>
        <div class="table-wrap">
          <table class="device-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Username</th>
                <th>Role</th>
                <th>Location</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="userTableBody">
              <tr class="empty-row">
                <td colspan="5">No users created yet.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

    </main>

    <script src="app-permissions.js"></script>
    <script src="app-session.js"></script>
    <script src="audit-log.js"></script>
    <script>
      const permissionsKey = window.assetTrackingPermissions
        ? window.assetTrackingPermissions.storageKey
        : "assetTrackingRolePermissions";
      const USERS_KEY = "assetTrackingUsers";
      const rolePermissionSelect = document.getElementById(
        "rolePermissionSelect"
      );
      const permissionChecklist = document.getElementById(
        "permissionChecklist"
      );
      const rolePermissionsForm = document.getElementById(
        "rolePermissionsForm"
      );
      const savePermissionsBtn = document.getElementById("savePermissionsBtn");
      const userForm = document.getElementById("userForm");
      const userTableBody = document.getElementById("userTableBody");

      const PERMISSIONS = [
        { key: "register_device", label: "Register device" },
        { key: "issuing_personal", label: "Assign phones (Personal)" },
        { key: "issuing_shared", label: "Assign phones (Shared)" },
        { key: "bulk_issuing", label: "Bulk issuing" },
        { key: "returning", label: "Returning" },
        { key: "location_list", label: "Location list" },
        { key: "user_management", label: "User management" },
      ];

      const DEFAULT_ROLE_PERMISSIONS = {
        Admin: [
          "register_device",
          "issuing_personal",
          "issuing_shared",
          "bulk_issuing",
          "returning",
          "location_list",
          "user_management",
        ],
        Supervisor: [
          "register_device",
          "issuing_personal",
          "issuing_shared",
          "bulk_issuing",
          "returning",
          "location_list",
        ],
        Operator: [
          "issuing_personal",
          "issuing_shared",
          "returning",
          "location_list",
        ],
        Viewer: [],
      };

      const getPermissions = () => {
        const stored = localStorage.getItem(permissionsKey);
        if (stored) {
          try {
            return JSON.parse(stored);
          } catch (error) {
            return (
              window.assetTrackingPermissions?.defaults ||
              DEFAULT_ROLE_PERMISSIONS
            );
          }
        }

        return (
          window.assetTrackingPermissions?.defaults || DEFAULT_ROLE_PERMISSIONS
        );
      };

      const savePermissions = (permissions) => {
        localStorage.setItem(permissionsKey, JSON.stringify(permissions));
      };

      const renderPermissionChecklist = (role) => {
        permissionChecklist.innerHTML = "";
        const permissions = getPermissions();
        const allowed = new Set(permissions[role] || []);

        PERMISSIONS.forEach((permission) => {
          const wrapper = document.createElement("label");
          wrapper.className = "check-item";
          wrapper.innerHTML = `
            <input type="checkbox" value="${permission.key}" ${
              allowed.has(permission.key) ? "checked" : ""
            } />
            <span>${permission.label}</span>
          `;
          permissionChecklist.appendChild(wrapper);
        });
        permissionChecklist.dataset.initialSignature = getChecklistSignature();
        updateSaveState();
      };

      rolePermissionSelect.addEventListener("change", () => {
        renderPermissionChecklist(rolePermissionSelect.value);
      });

      const getChecklistState = () =>
        Array.from(permissionChecklist.querySelectorAll("input")).map(
          (input) => ({
            key: input.value,
            checked: input.checked,
          })
        );

      const getChecklistSignature = () =>
        JSON.stringify(getChecklistState());

      const updateSaveState = () => {
        const initialSignature =
          permissionChecklist.dataset.initialSignature || "";
        const currentSignature = getChecklistSignature();
        if (!initialSignature) {
          permissionChecklist.dataset.initialSignature = currentSignature;
          savePermissionsBtn.disabled = true;
          return;
        }
        savePermissionsBtn.disabled = initialSignature === currentSignature;
      };

      permissionChecklist.addEventListener("change", updateSaveState);
      permissionChecklist.addEventListener("input", updateSaveState);
      permissionChecklist.addEventListener("click", updateSaveState);

      rolePermissionsForm.addEventListener("submit", (event) => {
        event.preventDefault();
        const selectedRole = rolePermissionSelect.value;
        const checked = Array.from(
          permissionChecklist.querySelectorAll("input:checked")
        ).map((input) => input.value);
        const permissions = getPermissions();
        permissions[selectedRole] = checked;
        savePermissions(permissions);
        window.auditLog.logAudit(
          "update_role_permissions",
          `${selectedRole}: ${checked.join(", ") || "none"}`
        );
        savePermissionsBtn.disabled = true;
        window.location.reload();
      });

      const renderUsers = (users) => {
        userTableBody.innerHTML = "";
        if (!users.length) {
          userTableBody.innerHTML = `
            <tr class="empty-row">
              <td colspan="4">No users created yet.</td>
            </tr>
          `;
          return;
        }

        users.forEach((user, index) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${user.name}</td>
            <td>${user.username}</td>
            <td>${user.role}</td>
            <td>${user.location || "—"}</td>
            <td>
              <button class="secondary-button" data-remove="${index}">
                Remove
              </button>
            </td>
          `;
          userTableBody.appendChild(row);
        });
      };

      const getUsers = () => {
        const stored = localStorage.getItem(USERS_KEY);
        if (!stored) {
          return [];
        }

        try {
          return JSON.parse(stored);
        } catch (error) {
          return [];
        }
      };

      const saveUsers = (users) => {
        localStorage.setItem(USERS_KEY, JSON.stringify(users));
      };

      userForm.addEventListener("submit", (event) => {
        event.preventDefault();
        const formData = new FormData(userForm);
        const name = String(formData.get("name") || "").trim();
        const username = String(formData.get("username") || "").trim();
        const role = String(formData.get("role") || "").trim();
        const location = String(formData.get("location") || "").trim();
        const password = String(formData.get("password") || "").trim();

        if (!name || !username || !role || !password) {
          return;
        }

        const users = getUsers();
        users.push({ name, username, role, location, password });
        saveUsers(users);
        renderUsers(users);
        userForm.reset();
        window.auditLog.logAudit(
          "create_user",
          `${name} (${username}) ${location ? `@ ${location}` : ""}`
        );

        if (!localStorage.getItem("assetTrackingCurrentUser")) {
          localStorage.setItem("assetTrackingCurrentUser", username);
        }
      });

      userTableBody.addEventListener("click", (event) => {
        const target = event.target;
        if (!(target instanceof HTMLButtonElement)) {
          return;
        }

        const index = target.getAttribute("data-remove");
        if (index === null) {
          return;
        }

        const users = getUsers();
        const removed = users.splice(Number(index), 1);
        saveUsers(users);
        renderUsers(users);
        if (removed.length) {
          window.auditLog.logAudit(
            "remove_user",
            `${removed[0].name} (${removed[0].username})`
          );
        }
      });

      renderPermissionChecklist(rolePermissionSelect.value);
      renderUsers(getUsers());
    </script>
  </body>
</html>
